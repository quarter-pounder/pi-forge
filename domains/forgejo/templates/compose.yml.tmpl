services:
  forgejo:
    image: {{ FORGEJO_IMAGE }}
    container_name: forgejo
    restart: unless-stopped
    environment:
      USER_UID: "{{ FORGEJO_UID }}"
      USER_GID: "{{ FORGEJO_GID }}"
{% set mailer_protocol = 'smtp+starttls' if SMTP_STARTTLS == 'true' else ('smtps' if SMTP_TLS == 'true' else 'smtp') %}
      FORGEJO__server__DOMAIN: "{{ FORGEJO_DOMAIN }}"
      FORGEJO__server__ROOT_URL: "{{ FORGEJO_EXTERNAL_URL }}"
      FORGEJO__server__SSH_DOMAIN: "{{ FORGEJO_DOMAIN }}"
      FORGEJO__server__SSH_PORT: "{{ PORT_FORGEJO_SSH }}"
      FORGEJO__server__HTTP_PORT: "3000"
      FORGEJO__server__PROTOCOL: "http"
      FORGEJO__lfs__START_SERVER: "true"
      FORGEJO__lfs__JWT_SECRET: "{{ FORGEJO_LFS_JWT_SECRET }}"
      FORGEJO__database__DB_TYPE: "postgres"
      FORGEJO__database__HOST: "forgejo-postgres:5432"
      FORGEJO__database__NAME: "{{ POSTGRES_DB_FORGEJO }}"
      FORGEJO__database__USER: "{{ POSTGRES_USER_FORGEJO }}"
      FORGEJO__database__PASSWD: "{{ POSTGRES_PASSWORD_FORGEJO }}"
      FORGEJO__database__SCHEMA: "public"
      FORGEJO__database__LOG_SQL: "false"
      FORGEJO__security__INTERNAL_TOKEN: "{{ FORGEJO_APP_SECRET }}"
      FORGEJO__security__SECRET_KEY: "{{ FORGEJO_APP_SECRET }}"
      FORGEJO__security__INSTALL_LOCK: "true"
      FORGEJO__metrics__ENABLED: "true"
      FORGEJO__metrics__TOKEN: "{{ FORGEJO_METRICS_TOKEN }}"
      FORGEJO__service__DISABLE_REGISTRATION: "true"
      FORGEJO__service__REQUIRE_SIGNIN_VIEW: "false"
      FORGEJO__service__ALLOW_ONLY_EXTERNAL_REGISTRATION: "false"
      FORGEJO__service__DEFAULT_KEEP_EMAIL_PRIVATE: "true"
      FORGEJO__oauth2__ACCESS_TOKEN_EXPIRATION_TIME: "{{ FORGEJO_OAUTH2_ACCESS_TOKEN_EXPIRATION_TIME | default('24h', true) }}"
      FORGEJO__mirror__ALLOWED_DOMAINS: "{{ FORGEJO_MIRROR_ALLOWED_DOMAINS }}"
      FORGEJO__mirror__BLOCKED_DOMAINS: "{{ FORGEJO_MIRROR_BLOCKED_DOMAINS }}"
      FORGEJO__mirror__ALLOW_LOCALNETWORKS: "{{ 'true' if FORGEJO_MIRROR_ALLOW_LOCALNETWORKS == 'true' else 'false' }}"
      FORGEJO__migrations__ALLOWED_DOMAINS: "{{ FORGEJO_MIRROR_ALLOWED_DOMAINS }}"
      FORGEJO__migrations__BLOCKED_DOMAINS: "{{ FORGEJO_MIRROR_BLOCKED_DOMAINS }}"
      FORGEJO__migrations__ALLOW_LOCALNETWORKS: "{{ 'true' if FORGEJO_MIRROR_ALLOW_LOCALNETWORKS == 'true' else 'false' }}"
      FORGEJO__actions__ENABLED: "true"
      FORGEJO__actions__DEFAULT_ACTIONS_URL: "github"
      FORGEJO__packages__ENABLED: "true"
      FORGEJO__packages__REGISTRY__ENABLED: "true"
      FORGEJO__packages__REGISTRY__LOG_PACKAGE_ACCESS: "true"
      FORGEJO__mailer__ENABLED: "{{ 'true' if SMTP_ADDRESS else 'false' }}"
      FORGEJO__mailer__PROTOCOL: "{{ mailer_protocol }}"
      FORGEJO__mailer__SMTP_ADDR: "{{ SMTP_ADDRESS if SMTP_ADDRESS else '' }}"
      FORGEJO__mailer__SMTP_PORT: "{{ SMTP_PORT if SMTP_PORT else '' }}"
      FORGEJO__mailer__USER: "{{ SMTP_USERNAME if SMTP_USERNAME else '' }}"
      FORGEJO__mailer__PASSWD: "{{ SMTP_PASSWORD if SMTP_PASSWORD else '' }}"
{% if SMTP_FROM and '@' in SMTP_FROM %}
      FORGEJO__mailer__FROM: "{{ SMTP_FROM }}"
{% elif DOMAIN %}
      FORGEJO__mailer__FROM: "noreply@{{ DOMAIN }}"
{% else %}
      FORGEJO__mailer__FROM: "noreply@localhost"
{% endif %}
      FORGEJO__mailer__SMTP_AUTH: "{{ SMTP_AUTH if SMTP_AUTH else '' }}"
      FORGEJO__mailer__FORCE_TRUST_SERVER_CERT: "{{ 'true' if SMTP_SSL_VERIFY_MODE == 'none' else 'false' }}"
      FORGEJO__mailer__USE_CLIENT_CERT: "false"
{% if FORGEJO_ADMIN_USERNAME and FORGEJO_ADMIN_PASSWORD and FORGEJO_ADMIN_EMAIL %}
      FORGEJO__admin__USER_CREATE__ENABLED: "true"
      FORGEJO__admin__USER_CREATE__USERNAME: "{{ FORGEJO_ADMIN_USERNAME }}"
      FORGEJO__admin__USER_CREATE__PASSWORD: "{{ FORGEJO_ADMIN_PASSWORD }}"
      FORGEJO__admin__USER_CREATE__EMAIL: "{{ FORGEJO_ADMIN_EMAIL }}"
      FORGEJO__admin__USER_CREATE__IS_ADMIN: "true"
      FORGEJO__admin__USER_CREATE__MUST_CHANGE_PASSWORD: "false"
{% else %}
      FORGEJO__admin__USER_CREATE__ENABLED: "false"
{% endif %}
    ports:
      - "{{ PORT_FORGEJO_HTTP }}:3000"
      - "{{ PORT_FORGEJO_SSH }}:22"
    volumes:
      - /srv/forgejo/data:/data
    dns:
      - 1.1.1.1
      - 8.8.8.8
    networks:
      - forgejo-network

networks:
  forgejo-network:
    external: true
    name: forgejo-network

