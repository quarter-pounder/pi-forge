services:
  pihole:
    image: {{ PIHOLE_IMAGE }}
    container_name: adblocker-pihole
    restart: always
    ports:
      - "{{ PORT_ADBLOCKER_DNS }}:53/tcp"
      - "{{ PORT_ADBLOCKER_DNS }}:53/udp"
      - "{{ PORT_ADBLOCKER_WEB }}:80/tcp"
    environment:
      TZ: {{ TIMEZONE if TIMEZONE else 'UTC' }}
      WEBPASSWORD: {{ PIHOLE_WEB_PASSWORD }}
      DNS1: "{{ ADBLOCKER_UNBOUND_IP }}#53"
      DNS2: "1.1.1.1"
      DNSSEC: "true"
      DNS_BOGUS_PRIV: "true"
      DNS_FQDN_REQUIRED: "false"
      INTERFACE: eth0
      VIRTUAL_HOST: {{ 'pihole.' ~ DOMAIN if DOMAIN else 'pihole.local' }}
      VIRTUAL_PORT: "80"
      PIHOLE_DNS_: "{{ ADBLOCKER_UNBOUND_IP }}#53;1.1.1.1;1.0.0.1"
      PIHOLE_DOMAIN: {{ DOMAIN if DOMAIN else 'local' }}
      FTLCONF_LOCAL_IPV4: {{ PIHOLE_LOCAL_IPV4 if PIHOLE_LOCAL_IPV4 else '192.168.1.100' }}
    volumes:
      - /srv/adblocker/pihole:/etc/pihole
      - /srv/adblocker/dnsmasq.d:/etc/dnsmasq.d
    healthcheck:
      test: ["CMD-SHELL", "dig +time=2 +tries=1 @127.0.0.1 pi.hole || exit 1"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 45s
    cap_add:
      - NET_ADMIN
    dns:
      - 127.0.0.11
      - 1.1.1.1
    networks:
      - adblocker-network
    depends_on:
      - unbound

  unbound:
    image: {{ UNBOUND_IMAGE }}
    container_name: adblocker-unbound
    restart: always
    user: "0:0"
    ports:
      - "{{ PORT_ADBLOCKER_UNBOUND }}:53/tcp"
      - "{{ PORT_ADBLOCKER_UNBOUND }}:53/udp"
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 53 || (pgrep -f 'unbound -d' > /dev/null && exit 0) || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    volumes:
      - ./unbound.conf:/etc/unbound/unbound.conf:ro
      - /srv/adblocker/unbound:/var/lib/unbound
    entrypoint:
      - /bin/sh
      - -c
      - |
        mkdir -p /var/lib/unbound \
          && chown -R unbound:unbound /var/lib/unbound \
          && if [ ! -f /var/lib/unbound/root.key ]; then
               su -s /bin/sh unbound -c 'unbound-anchor -a /var/lib/unbound/root.key' || exit 1;
             fi \
          && exec su -s /bin/sh unbound -c 'unbound -d -v'
    networks:
      adblocker-network:
        ipv4_address: {{ ADBLOCKER_UNBOUND_IP }}

networks:
  adblocker-network:
    name: adblocker-network
    driver: bridge
    ipam:
      config:
        - subnet: {{ ADBLOCKER_NETWORK_SUBNET }}
